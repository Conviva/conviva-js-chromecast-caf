/*! (C) 2025 Conviva, Inc. All rights reserved. Confidential and proprietary. */
((t,i)=>{var s;"function"===typeof define&&define.amd?define(i):("object"===typeof exports||"object"===typeof module&&module.exports)&&(module.exports=i()),"undefined"!==typeof t&&t&&("undefined"!==typeof t.Conviva&&t.Conviva?t.Conviva.ProxyMonitor||t.ConvivaModuleLoading||(s=i(),t.ConvivaModuleLoading=!0,t.Conviva.ProxyMonitor=s.ProxyMonitor,t.Conviva.Impl.CAFProxy=s.Impl.CAFProxy,delete t.ConvivaModuleLoading):t.ConvivaModule||t.ConvivaModuleLoading||(t.ConvivaModuleLoading=!0,t.ConvivaModule=i(),delete t.ConvivaModuleLoading))})(this,function(){var e={};function t(t,i,s,c){var h=this;h.t=[],h.i=0,h.o=0,h.h=!1,this.u=new c.Impl.Html5Timer,this.N=-1,this.l=-1,this.v=-1,this.p=0,this.C=0,this.A=c.Constants.PlayerState.BUFFERING,this.m=!1,this.F=0,this.P=-1,this.V="",this.I=function(){h.O&&(h.O.addEventListener(cast.framework.events.EventType.LOAD_START,h.onLoadstart),h.O.addEventListener(cast.framework.events.EventType.LOADED_METADATA,h.onLoadedMetadata),h.O.addEventListener(cast.framework.events.EventType.MEDIA_FINISHED,h.onMediaFinished),h.O.addEventListener(cast.framework.events.EventType.PAUSE,h.onPause),h.O.addEventListener(cast.framework.events.EventType.SEEKING,h.onSeeking),h.O.addEventListener(cast.framework.events.EventType.SEEKED,h.onSeekComplete),h.O.addEventListener(cast.framework.events.EventType.ERROR,h.onError),h.O.addEventListener(cast.framework.events.EventType.BITRATE_CHANGED,h.onBitrateChange))},this.M=function(){h.O&&(h.O.removeEventListener(cast.framework.events.EventType.LOAD_START,h.onLoadstart),h.O.removeEventListener(cast.framework.events.EventType.LOADED_METADATA,h.onLoadedMetadata),h.O.removeEventListener(cast.framework.events.EventType.MEDIA_FINISHED,h.onMediaFinished),h.O.removeEventListener(cast.framework.events.EventType.PAUSE,h.onPause),h.O.removeEventListener(cast.framework.events.EventType.SEEKING,h.onSeeking),h.O.removeEventListener(cast.framework.events.EventType.SEEKED,h.onSeekComplete),h.O.removeEventListener(cast.framework.events.EventType.ERROR,h.onError),h.O.removeEventListener(cast.framework.events.EventType.BITRATE_CHANGED,h.onBitrateChange))},this.onLoadstart=function(){h.k("CAFProxy.onLoadstart"),h.R(c.Constants.PlayerState.BUFFERING)},this.onLoadedMetadata=function(){h.k("CAFProxy.onLoadedMetadata"),h.U()},this.onBitrateChange=function(t){h.F=Math.round(t.totalBitrate/1e3),h._.reportPlaybackMetric(c.Constants.Playback.BITRATE,h.F,"CONVIVA")},this.onPause=function(){h.k("CAFProxy.onPause"),h.R(c.Constants.PlayerState.PAUSED)},this.onMediaFinished=function(){h.k("CAFProxy.onMediaFinished"),h.O&&h.R(c.Constants.PlayerState.STOPPED)},this.onSeeking=function(){h.isSeekStarted||(h.isSeekStarted=!0,h.k("CAFProxy.onSeeking"),h._.reportPlaybackMetric(c.Constants.Playback.SEEK_STARTED,"CONVIVA"))},this.onSeekComplete=function(){h.k("CAFProxy.onSeekComplete"),h._.reportPlaybackMetric(c.Constants.Playback.SEEK_ENDED,"CONVIVA"),h.isSeekStarted=!1},this.onError=function(t){var i,s,n;h.k("CAFProxy.onError"),h.O&&(i=t.error,s=t.detailedErrorCode,t=t.reason,"undefined"!==typeof i&&i?s===cast.framework.events.DetailedErrorCode.BREAK_CLIP_LOADING_ERROR||s===cast.framework.events.DetailedErrorCode.BREAK_SEEK_INTERCEPTOR_ERROR?(n=h.g(i?i.type:"UNKNOWN",s,t),h._.reportPlaybackError(n,c.Constants.ErrorSeverity.WARNING)):(n=h.g(i?i.type:"UNKNOWN",s,t),h._.reportPlaybackError(n,c.Constants.ErrorSeverity.FATAL)):(n=h.g("UNKNOWN",s,t),h._.reportPlaybackError(n,c.Constants.ErrorSeverity.FATAL)))},this.g=function(t,i,s){var n;switch(t){case cast.framework.messages.ErrorType.LOAD_FAILED:n=cast.framework.messages.ErrorType.LOAD_FAILED;break;case cast.framework.messages.ErrorType.INVALID_PLAYER_STATE:n=cast.framework.messages.ErrorType.INVALID_PLAYER_STATE;break;case cast.framework.messages.ErrorType.ERROR:n=cast.framework.messages.ErrorType.ERROR;break;default:n="MEDIA_ERR_UNKNOWN"}if("undefined"!==typeof i)for(var e in cast.framework.events.DetailedErrorCode)if(cast.framework.events.DetailedErrorCode[e]===i){n+=" - "+e;break}if("undefined"!==typeof s)for(var a in cast.framework.events.ErrorReason)if(cast.framework.events.ErrorReason[a]===s){n+=" - "+a;break}return h.k("MediaError: type "+t+" "+n),n},this.R=function(t){h.A=t,h._.reportPlaybackMetric(c.Constants.Playback.PLAYER_STATE,t,"CONVIVA"),h.j(),h.K=!0},this.U=function(){var t,i,s;h.O&&(t=(s=h.O.getStats()).width,i=s.height,s=s.droppedFrames,(!isNaN(t)&&t>0&&t!==h.N||!isNaN(i)&&i>0&&i!==h.l)&&(h.N=t,h.l=i,h._.reportPlaybackMetric(c.Constants.Playback.RESOLUTION,t,i,"CONVIVA")),!isNaN(s)&&s>=0&&s!==h.v&&(h.v=s,h._.reportPlaybackMetric(c.Constants.Playback.DROPPED_FRAMES_TOTAL,s,"CONVIVA")),t={},"function"===typeof h.O.getDurationSec&&h.O.getDurationSec()>0&&(i=h.O.getDurationSec())!==h.P&&(h.P=i,t[c.Constants.DURATION]=i),"function"===typeof h.O.getMediaInformation&&h.O.getMediaInformation()&&h.O.getMediaInformation().contentId&&(s=h.O.getMediaInformation().contentId)!==h.V&&(h.V=s,t[c.Constants.STREAM_URL]=s),"{}"!==JSON.stringify(t))&&h._.setContentInfo(t)},this.W=function(){var t;h._&&((t={})[c.Constants.DeviceMetadata.TYPE]=c.Constants.DeviceType.SETTOP,t[c.Constants.DeviceMetadata.CATEGORY]=c.Constants.DeviceCategory.CHROMECAST,c.Analytics.setDeviceMetadata(t))},this.D=function(){this.G=0,this.L=0,this.S=0,this.B=this.u.createTimer(this.J,250,"CAFProxy._poll()")},this.J=function(){var t,i;h.O&&(h.C%4===0&&(t=h.O.getStats().decodedFrames,i=Math.floor(t-h.p),h.p=t,isNaN(i)),h.C++),h._.reportPlaybackMetric(c.Constants.Playback.PLAY_HEAD_TIME,1e3*h.Y.currentTime,"CONVIVA"),h.U(),h.q(),h.H()},this.q=function(){h.G=h.L,h.L=h.Y.currentTime;var t,i=Date.now();h.T>0&&i>h.T&&(t=(t=(t=h.L-h.G)<0?0:t)/(i-h.T)*1e3,h.t.push(t)),h.T=i,h.t.length>Math.max(4,4)&&h.t.shift()},this.H=function(){var t=h.t.length;if(t>=Math.min(4,4)){for(var i=0,s=h.t.slice(),n=0;n<s.length;n++)i+=s[n];i/=t;var e=1,a=.25,o=h.O.getPlaybackRate();!isNaN(o)&&o!==1/0&&o>0&&(e=e*o,a=a*o),h.A!==c.Constants.PlayerState.PLAYING&&t>=4&&Math.abs(i-e)<a?(h.k("Adjusting Conviva player state to: PLAYING"),h.R(c.Constants.PlayerState.PLAYING)):(h.A===c.Constants.PlayerState.PLAYING||h.A!==c.Constants.PlayerState.PLAYING&&"BUFFERING"===h.O.getPlayerState())&&t>=4&&0===i&&(h.k("Adjusting Conviva player state to: BUFFERING"),h.R(c.Constants.PlayerState.BUFFERING))}},this.X=function(){this.B&&(this.B(),this.B=null)},this.j=function(){h.t=[],h.G=-1,h.T=0},this.Z=function(){h.o=0,h.i=0},this.k=function(t){this.$.log(t,c.SystemSettings.LogLevel.DEBUG)},function(t,i,s,n){if(!t)throw new Error("cafProxy: videoElement argument cannot be null.");if(this.O=t,document.getElementsByTagName("cast-media-player")&&document.getElementsByTagName("cast-media-player").length>0)this.Y=document.getElementsByTagName("cast-media-player")[0].getMediaElement();else if(document.getElementsByTagName("video")&&document.getElementsByTagName("video").length>0){var e=document.getElementsByTagName("video");this.Y=e[0];for(var a=0;a<e.length&&e.length>1;a++)if(e[a].getAttribute("class")&&-1!==e[a].getAttribute("class").indexOf("castMediaElement")){this.Y=e[a];break}}this._=s,this.$=i.buildLogger(),this.$.setModuleName("cafProxy"),this.k("cafProxy._constr()"),this.I(),this.j(),this.Z(),this.D(),this.W(),this.R(this.A),this.U(),(t={})[n.Constants.MODULE_NAME]="Chromecast CAF Receiver",t[n.Constants.MODULE_VERSION]="4.0.13",this._.setContentInfo(t),(s={})[n.Constants.FRAMEWORK_NAME]="Cast Receiver v3","undefined"!==typeof cast.framework&&(s[n.Constants.FRAMEWORK_VERSION]=cast.framework.VERSION),this._.setPlayerInfo(s)}.apply(this,arguments),this.cleanup=function(){this.k("cafProxy.cleanup()"),this.X(),this.M(),this.O=null}}return e.ProxyMonitor={tt:null,release:function(){this.tt&&this.tt.cleanup()},initConvivaDropIn:function(t,i,s,n){if(t)return this.tt=new e.Impl.CAFProxy(t,i,s,n),this.tt;throw new Error("No player proxy initialized")}},"undefined"!==typeof e&&(e.Impl=e.Impl||{},e.Impl.CAFProxy=t),e});